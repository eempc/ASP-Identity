# Actions
* Instructions on how to add a custom user identity with additional fields such as name and date of birth

https://docs.microsoft.com/en-us/aspnet/core/security/authentication/add-user-data?view=aspnetcore-3.0&tabs=visual-studio

## Cardinal rule

If you intend to make a web app and storing user info with additional fields in the web app (i.e. not utilising google or facebook login), then do not ever use the creation wizard's Add Authorisation. Take the time to scaffold and add the identity manually. This will avoid the conflict between ApplicationDbContext which is generated by the wizard and the WebApplication1Context generated by the manual method.

## Steps

1. Create a standard Razor web app (non-MVC, non-SPA) without authorisation
2. Right-click project and add Identity Scaffold, the options to tick are: Account/Register and Account/Manage/Index, it might just be Account/Manage though
3. Create the new Data context class and the new user class, (no need to modify the layout file) then Add
4. Migrate and update the newly generated database context
5. Add app.UseAthentication(); to Startup.cs
6. Add <partial name="_LoginPartial" /> to the header of the layout file
7. Go to your user model, e.g. WebApplicationUser1.cs
8. Add [PersonalData] properties
9. Update the razor pages and associated cs files

    * Manage/Index.cshtml changes required:
    ```Add properties to InputModels within the constructor, LoadAsync (not GetAsync), PostAsync - will have to refer to the document for this one, will mark the new stuff with asterisks```

    * Register.cshtml changes required:
    ```Add properties to InputModels within the constructor, and onPostAsync```

10. Build then migrate

-----------

## Unifying the DBcontext

* DBContext services startup will be moved to IdentityHostingStartup.cs
* The contents of this can be moved back to Startup.cs with a few differences.

```[assembly: HostingStartup(typeof(WebApplication1.Areas.Identity.IdentityHostingStartup))] // This bit may not be required, it can be commented out
namespace WebApplication1 {
    public class Startup {
        public Startup(IConfiguration configuration) {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services) {
            services.AddDbContext<WebApplication1Context>(options =>
                options.UseSqlServer(
                    Configuration.GetConnectionString("WebApplication1ContextConnection")));

            services.AddDefaultIdentity<WebApplication1User>(options => options.SignIn.RequireConfirmedAccount = true)
                .AddEntityFrameworkStores<WebApplication1Context>();

            services.AddRazorPages();
        }
        ... etc ...
 ```


-----------

# Adding the main model to work with

For the most fuss-free method of adding a model, use the CRUD scaffolder to create a separate database for the main model. But then you end up with two databases. However it is just the same as before:

1. Add the main Model that you will be working with
2. Scaffold that model
3. Add services.AddScoped<IModelName, ModelName>(); (maybe not necessary)
4. Add-Migration AddModel then Update-Database
* Create.cshtml has this hidden field UserID which will be recorded in the main country model as who added that country
```
<form method="post">
    <!-- Create a hidden <input> which will assign the user ID -->
    <input type="hidden" asp-for="Country.UserID" value="@Model.userId" />
```
* And the .cs file
```
public string userId; // Declare the user ID in order to assign it later
public IActionResult OnGet()
{
    userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value; // Initialise user ID, then can use it in the CSHMTL file
    return Page();
}
```


